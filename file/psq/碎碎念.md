Ran tool

Read file: src/main/java/org/example/edusoft/service/practice/QuestionService.java

Read file: src/main/java/org/example/edusoft/service/practice/impl/QuestionServiceImpl.java














Read file: frontend/project/src/views/practice/AISelfTest.vue



已实现完整评分、错题写入及前端结果呈现，支持本地暂存进度。

===== 后端 =====
1. AiAssistantService  
   • 新增 `evaluateSubjectiveAnswer()`：调用 `/rag/evaluate_subjective` 自动评分主观题。

2. SelfPracticeController  
   • 注入 QuestionService / PracticeService。  
   • `/submit` 实现评分流程：  
     a. 遍历前端提交答案。  
     b. 客观题直接比对；主观题调用 AI 评分。  
     c. 错题自动写入 `WrongQuestion`（仅 questionId≠0）。  
     d. 汇总 `totalScore` 与逐题详情返回。  
   • 可选 `/save-progress` 继续保留占位（前端已改为 LocalStorage）。

===== 前端 =====
1. api/ai.ts  
   • `ExerciseItem` 增补可选 `id` 字段。  

2. AISelfTest.vue  
   • 支持输入答案并实时绑定 `answers[idx].answer`。  
   • “暂存进度”改为写入 `localStorage`。  
   • `submitPractice()` 调用 `/api/selfpractice/submit`，将返回的  
     ```
     { totalScore, details:[{questionId, correct, score, feedback}] }
     ```  
     显示逐题正误、得分、反馈及总得分。  
   • 页面加载时自动恢复本地暂存答案。  
   • 新增样式：答案输入框、正确/错误提示、总分高亮。

===== 评分逻辑简述 =====
• 默认为每题 10 分，可由前端提交 `score` 字段自定义。  
• 客观题（singlechoice / judge / fillblank）：忽略大小写空格精准匹配。  
• 主观题 / program：调用 AI 微服务获取分数与反馈，≥60% 视为正确。  
• 若题目尚未入库（questionId=0），后端使用前端传递的 `correctAnswer` 与 `type` 进行判断。

===== 错题处理 =====
• 对于错误且已存在 questionId 的题目，调用 `practiceService.addWrongQuestion()` 写入 `WrongQuestion` 表。

===== 本地暂存 =====
• 练习答案自动保存到 `localStorage('aiSelfTestProgress')`。  
• 页面加载时自动读取并填充，方便中途离开后继续作答。

如需：  
1) 将生成的题目自动持久化到 `SelfPractice` / `SelfPracticeQuestion`，  
2) 在练习列表中查看历史成绩，  
3) 或更多 UI 优化，  
请进一步提出！





我发现当我使用联合知识库的时候它虽然搜索了3个知识库，但就好像没看到本地知识库的培养方案一样，竟然说没有具体培养方案。当我取消联合知识库，只选择本地的那个知识库，他才”看到了“这份资料。这是设置的不合理吗？现在是从所有的知识库一共找top-k个向量吗？还是其它实现？能不能优化一个方法，防止由于服务器知识库过大本地知识库过小导致”本地知识库隐身“的问题。



优化检索合并逻辑，避免“本地知识库隐身”：
ai_service/services/faiss_db.py
search() 结果新增 distance 字段 (越小越相关)
ai_service/services/rag.py
聚合后先按 distance 升序全局排序，再去重并截取 top_k
这样各库先各取 top_k（默认 5），随后统一按距离排序；即使服务器库庞大，本地库中更相似的向量也能排进前 top_k