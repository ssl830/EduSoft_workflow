<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.example.edusoft.mapper.chat.ChatMessageMapper">

    <select id="getSessionMessages" resultType="org.example.edusoft.entity.chat.ChatMessage">
        SELECT * FROM chat_message 
        WHERE session_id = #{sessionId} 
        ORDER BY message_order ASC
    </select>

    <select id="getRecentMessages" resultType="org.example.edusoft.entity.chat.ChatMessage">
        SELECT * FROM chat_message 
        WHERE session_id = #{sessionId} 
        ORDER BY message_order DESC 
        LIMIT #{limit}
    </select>

    <select id="getMessagesByRange" resultType="org.example.edusoft.entity.chat.ChatMessage">
        SELECT * FROM chat_message 
        WHERE session_id = #{sessionId} 
        AND message_order BETWEEN #{startOrder} AND #{endOrder}
        ORDER BY message_order ASC
    </select>

    <select id="getSessionMessageCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM chat_message 
        WHERE session_id = #{sessionId}
    </select>

    <select id="getMaxMessageOrder" resultType="java.lang.Integer">
        SELECT COALESCE(MAX(message_order), 0) FROM chat_message 
        WHERE session_id = #{sessionId}
    </select>

    <select id="calculateSessionTokenCount" resultType="java.lang.Integer">
        SELECT COALESCE(SUM(token_count), 0) FROM chat_message 
        WHERE session_id = #{sessionId}
    </select>

</mapper>
