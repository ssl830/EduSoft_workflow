## 一、环境配置说明

### 1. 密钥配置（敏感信息）

`./ai_service/.env` 文件

```ini
# ===== Python AI 微服务 =====
# DEEPSEEK模型服务
DEEPSEEK_API_KEY=sk-34adae7291bc4addb0e2daba20fed438

# 阿里云模型服务
DASHSCOPE_API_KEY=sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Qwen Embedding 配置
QWEN_EMBEDDING_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
# QWEN_EMBEDDING_MODEL=text-embedding-v3
# QWEN_EMBEDDING_DIM=1024
QWEN_EMBEDDING_MODEL=text-embedding-v4  
QWEN_EMBEDDING_DIM=1536

# 存储配置
STORAGE_ROOT=storage
VECTOR_DB_PATH=data/vector_db
TEMP_DIR=storage/temp

# 服务器配置
HOST=0.0.0.0
PORT=8000
DEBUG=True
  
# OpenMP Configuration
KMP_DUPLICATE_LIB_OK=TRUE
```

---
`./src/main/resources/application.properties` 文件

```ini
# ...
# 数据库配置 (application.properties)
spring.datasource.url=jdbc:mysql://your-db-host:3306/courseplatform
spring.datasource.username=your_db_user
spring.datasource.password=your_db_password

# ...

# 文件存储配置（阿里云 OSS 配置）
fs.files-server.type=aliyunOSS
fs.files-server.aliyun-oss.access-key=your_aliyun_access_key
fs.files-server.aliyun-oss.secret-key=your_aliyun_secret_key
fs.files-server.aliyun-oss.end-point=oss-cn-beijing.aliyuncs.com
fs.files-server.aliyun-oss.bucket=your_bucket_name

# ...

# AI 服务配置
ai.service.api-key=your_ai_service_key
```

### 2. 模型选择配置
在 Python 微服务中默认使用以下模型：
- **文本嵌入模型**：Qwen text-embedding-v4
- **大语言模型**：DeepSeek-V3-0324

其中文本嵌入模型可通过修改 `.env` 文件调整为开源模型Qwen text-embedding-v3：
```ini
# QWEN_EMBEDDING_MODEL=text-embedding-v3
# QWEN_EMBEDDING_DIM=1024         # v3支持: 64,128,256,512,768,1024  
QWEN_EMBEDDING_MODEL=text-embedding-v4  
QWEN_EMBEDDING_DIM=1536       # v4支持: 1024,1536,2048,3072,4096
```

## 二、部署说明

### 1. 系统架构
```
用户浏览器 -> Vue3前端(3000) -> Spring Boot后端(8080) -> Python AI微服务(8000)
                               -> MySQL数据库
                               -> 阿里云OSS
```

### 2. 依赖安装

#### 系统级依赖
```bash
# FFmpeg (视频处理)
sudo apt install ffmpeg  # Linux
# 或从 https://ffmpeg.org/download.html 下载 Windows 版

# Tesseract-OCR (图片识别)
sudo apt install tesseract-ocr libtesseract-dev  # Linux
# 或从 https://github.com/tesseract-ocr/tesseract 下载 Windows 版
```

### 3. 部署流程

#### 前端部署 (Vue3+TypeScript)
```bash
cd frontend/project

# 安装依赖
npm install

# 开发模式运行
npm run dev

# 生产构建
npm run build
```

**vite.config.ts 关键配置**：
```typescript
export default defineConfig({
  base: './',
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      },
      '/ai': {
        target: 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})
```

#### 后端部署 (Spring Boot)
1. 配置 `application.properties`：
```properties
# 数据库配置
spring.datasource.url=jdbc:mysql://localhost:3306/courseplatform
spring.datasource.username=root
spring.datasource.password=your_password

# AI 服务地址
ai.service.url=http://localhost:8000
```

2. 运行应用：
```bash
# 开发模式
mvn spring-boot:run

# 生产打包
mvn clean package
java -jar target/your-app.jar
```

#### Python AI 微服务部署
```bash
cd ai_service

# 创建虚拟环境 (Windows)
python -m venv venv
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt

# 开发模式运行
uvicorn main:app --host 0.0.0.0 --port 8000 --reload

# 生产模式 (使用 Gunicorn)
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app
```

### 4. OCR 配置（必需）
1. **Tesseract 安装**：
	- Windows：从 [Tesseract GitHub](https://github.com/tesseract-ocr/tesseract) 下载安装
	- Linux：`sudo apt install tesseract-ocr`

2. **配置环境变量**：
	- 添加 Tesseract 安装目录到系统 PATH
	- 重启终端

3. **语言包安装**：
```bash
# 简体中文包
sudo apt install tesseract-ocr-chi-sim  # Linux
# 或从 https://github.com/tesseract-ocr/tessdata 下载 chi_sim.traineddata
# 放到 Tesseract-OCR/tessdata 目录
```

4. **修改 Python 代码**：
```python
# 在 doc_parser.py 中设置正确路径
pytesseract.pytesseract.tesseract_cmd = r"C:\Program Files\Tesseract-OCR\tesseract.exe"  # Windows
# 或
# pytesseract.pytesseract.tesseract_cmd = '/usr/bin/tesseract'  # Linux
```

## 三、配置文件详解

### 1. Python AI 微服务 (.env)
| 配置项                    | 说明           | 默认值                                               |
| ---------------------- | ------------ | ------------------------------------------------- |
| `DASHSCOPE_API_KEY`    | 阿里云模型API密钥   | **必填**                                            |
| `DASHSCOPE_API_KEY`    | 通义千问模型API密钥  | **必填**                                            |
| `QWEN_EMBEDDING_URL`   | 通义千问模型的API地址 | https://dashscope.aliyuncs.com/compatible-mode/v1 |
| `QWEN_EMBEDDING_MODEL` | 使用的嵌入模型      | `text-embedding-v4`                               |
| `QWEN_EMBEDDING_DIM`   | 向量维度         | `1536`                                            |
| `STORAGE_ROOT`         | 文件存储根目录      | `storage`                                         |
| `VECTOR_DB_PATH`       | 向量数据库路径      | `data/vector_db`                                  |
| `TEMP_DIR`             | 临时文件目录       | `storage/temp`                                    |
| `HOST`                 | 服务监听地址       | `0.0.0.0`                                         |
| `PORT`                 | 服务端口         | `8000`                                            |
| `DEBUG`                | 调试模式         | `True`                                            |

### 2. Spring Boot (application.properties)
| 配置项                                      | 说明                                          |
| ---------------------------------------- | ------------------------------------------- |
| `spring.datasource.url`                  | MySQL 数据库连接 URL                             |
| `spring.datasource.username`             | 数据库用户名                                      |
| `spring.datasource.password`             | 数据库密码                                       |
| `fs.files-server.aliyun-oss.*`           | 阿里云OSS配置，`access-key` 和 `secret-key` **必填** |
| `ai.service.url`                         | Python AI服务地址                               |
| `ai.service.api-key`                     | AI服务认证密钥                                    |
| `spring.servlet.multipart.max-file-size` | 文件上传大小限制 (100MB)                            |

### 3. Vue 前端 (vite.config.ts)
| 配置项 | 说明 |
|--------|------|
| `base` | 基础路径 (`./` 相对路径) |
| `server.port` | 开发服务器端口 (3000) |
| `server.proxy` | API代理配置 |
| `resolve.alias` | 路径别名配置 |

## 四、验证服务

1. **Python AI 微服务**：
```bash
curl http://localhost:8000/health
# 返回
# StatusCode        : 200
# StatusDescription : OK
# Content           : {"status":"healthy"}
# ...
```

2. **Spring Boot 后端**：
```bash
curl http://localhost:8080/actuator/health
# 返回
# StatusCode        : 200
# ...
```

3. **Vue 前端**：
   访问 http://localhost:3000 应显示应用界面

## 五、生产环境建议

1. **安全加固**：
	- 设置 `DEBUG=False` 禁用调试模式
	- 使用 HTTPS 加密通信
	- 定期轮换 API 密钥

2. **性能优化**：
```bash
# 使用 Gunicorn 运行 Python 服务
gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app

# Spring Boot 增加 JVM 参数
java -jar -Xmx2048m -XX:+UseG1GC your-app.jar
```

3. **依赖管理**：
```bash
# 冻结 Python 依赖
pip freeze > requirements.txt

# 前端依赖锁定
npm ci --omit=dev
```

4. **日志管理**：
```properties
# Spring Boot 日志配置
logging.file.name=application.log
logging.level.root=INFO
```

## 六、故障排查

| 问题现象 | 解决方案 |
|----------|----------|
| 无法解析图片/PDF | 检查 Tesseract 安装和路径配置 |
| 视频处理失败 | 验证 FFmpeg 安装和 PATH 配置 |
| API 调用 401 错误 | 检查 DASHSCOPE_API_KEY 是否有效 |
| 数据库连接失败 | 验证 application.properties 中的数据库配置 |
| 前端代理失败 | 检查 vite.config.ts 中的 proxy 配置 |
| 文件上传失败 | 检查 Spring Boot 的文件大小限制配置 |
